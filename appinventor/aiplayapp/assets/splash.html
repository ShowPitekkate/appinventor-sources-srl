<html>
    <head>
        <title>Welcome to App Inventor</title>
        <script type="text/javascript">
         var permissions = ['android.permission.CAMERA',
                            'android.permission.WRITE_EXTERNAL_STORAGE']
         function test() {
             var item = document.getElementById("foo");
             item.innerHTML = "<b>Clicked</b>";
         }
         function permresult(permission, result) {
             var item = document.getElementById("foo");
             item.innerHTML = "Permission " + permission + " = " + result;
             start();/* Re-evaluate whether or not to display */
         }
         function hasallpermissions() {
             var haveall = true;
             for (i = 0; i < permissions.length; i++) {
                 haveall = haveall && Android.hasPermission(permissions[i]);
             }
             return haveall;
         }
         function start() {
             var item = document.getElementById("needpermission");
             if (!hasallpermissions()) {
                 item.style.display = "block";
             } else {
                 item.style.display = "none";
             }
         }
         function getpermission() {
             for (i = 0; i < permissions.length; i++) {
                 var perm = permissions[i];
                 if (!Android.hasPermission(perm)) {
                     Android.askPermission(perm);
                     break;
                 }
             }
         }
         function done() {
             Android.finished();
         }
        </script>
        <script type="text/javascript">
         var rendezvous = 'http://jis.qyv.net:3000/'
         var servers = { 'iceServers' : [ { 'urls' : ['stun:stun.l.google.com:19302']}]};
         var data;
         var peer;
         var key;
         var seennonce = {};
         function newnonce() {
             return Math.floor(Math.random() * 10000) + 1;
         };
         function sender() {
             var offer;
             var poller;
             var poll = function() {
                 xhr = new XMLHttpRequest();
                 xhr.open('GET', rendezvous + key + '-r', true);
                 xhr.onreadystatechange = function() {
                     if (this.readyState == 4 && this.status == 200) {
                         if (this.response[0] == '[') {
                             var json = JSON.parse(this.response);
                             for (var i = 0; i < json.length; i++ ){
                                 var hunk = json[i];
                                 var candidate = hunk['candidate'];
                                 offer = hunk['offer'];
                                 if (candidate) {
                                     var nonce = hunk['nonce'];
                                     if (!seennonce[nonce]) {
                                         seennonce[nonce] = true;
                                         peer.addIceCandidate(candidate);
                                     } else {
                                         console.log("Seen nonce " + nonce);
                                     }
                                 } else if (offer) {
                                     peer.setRemoteDescription(offer);
                                 }
                             }
                         }
                     }
                 }
                 xhr.send();
             };
             peer = new RTCPeerConnection(servers);
             peer.onicecandidate = function(evt) {
                 if (evt.type == 'icecandidate') {
                     xhr = new XMLHttpRequest();
                     xhr.open('POST', rendezvous, true);
                     xhr.send(JSON.stringify({'key' : key + '-s',
                                              'webrtc' : true,
                                              'nonce' : newnonce(),
                                              'candidate' : evt.candidate}));
                 }
             }
             data = peer.createDataChannel('data');
             data.onopen = function() {
                 clearInterval(poller);
                 var b = document.getElementById("chatbutton");
                 b.disabled = false;
                 data.onmessage = function(ev) {
                     var data = ev.data;
                     var c = document.getElementById("chat");
                     c.innerHTML = c.innerHTML + '<br/>' + data;
                 };
                 alert('ready');
                 // Ready to actually exchange data
             }
             peer.createOffer().then(function(desc) {
                 offer = desc;
                 xhr = new XMLHttpRequest();
                 xhr.open('POST', rendezvous, true);
                 xhr.send(JSON.stringify({'key' : key + '-s',
                                          'webrtc' : true,
                                          'offer' : desc}));
                 peer.setLocalDescription(desc);
             });
             poller = setInterval(poll, 1000);
         };
         function receiver() {
             var offer;
             var poller;
             var poll = function() {
                 xhr = new XMLHttpRequest();
                 xhr.open('GET', rendezvous + key + '-s', true);
                 xhr.onreadystatechange = function() {
                     if (this.readyState == 4 && this.status == 200) {
                         if (this.response[0] == '[') {
                             var json = JSON.parse(this.response);
                             for (var i = 0; i < json.length; i++ ) {
                                 var hunk = json[i];
                                 var candidate = hunk['candidate'];
                                 offer = hunk['offer'];
                                 if (candidate) {
                                     var nonce = hunk['nonce'];
                                     if (!seennonce[nonce]) {
                                         seennonce[nonce] = true;
                                         peer.addIceCandidate(candidate);
                                     } else {
                                         console.log("Seen nonce " + nonce);
                                     }
                                 } else if (offer) {
                                     peer.setRemoteDescription(offer);
                                     peer.createAnswer().then(function(desc) {
                                         xhr = new XMLHttpRequest();
                                         xhr.open('POST', rendezvous, true);
                                         xhr.send(JSON.stringify({'key' : key + '-r',
                                                                  'webrtc' : true,
                                                                  'offer' : desc}));
                                         peer.setLocalDescription(desc);
                                     });
                                 }
                             }
                         }
                     }
                 }
                 xhr.send();
             };
             peer = new RTCPeerConnection(servers);
             peer.onicecandidate = function(evt) {
                 if (evt.type == 'icecandidate') {
                     xhr = new XMLHttpRequest();
                     xhr.open('POST', rendezvous, true);
                     xhr.send(JSON.stringify({'key' : key + '-r',
                                              'webrtc' : true,
                                              'nonce' : newnonce(),
                                              'candidate' : evt.candidate}));
                 }
             }
             peer.ondatachannel = function(ev) {
                 data = ev.channel;
                 data.onopen = function() {
                     clearInterval(poller);
                     var b = document.getElementById("chatbutton");
                     b.disabled = false;
                     data.onmessage = function(ev) {
                         var message = ev.data;
                         if (message[0] == '#') {
//                             message = "(*.toString " + message + ")";
                             retval = Android.doScheme(message.slice(1));
                             data.send(retval);
                         } else {
                             var c = document.getElementById("chat");
                             c.innerHTML = c.innerHTML + '<br/>' + message;
                         }
                     };
                     alert("ready");
                     // Ready to actually exchange data
                 }
             };
             poller = setInterval(poll, 1000);
         };
         function chat() {
             var t = document.getElementById("send");
             var c = document.getElementById("chat");
             c.innerHTML = c.innerHTML + '<br/>' + t.value;
             data.send(t.value);
         };
         function setkey() {
             var k = document.getElementById("key").value;
             key = k;
             document.getElementById("sendbutton").disabled = false;
             document.getElementById("receivebutton").disabled = false;
         }
        </script>
    </head>
    <body onload="start();">
        <center>
            <h1>Welcome to App Inventor!</h1>
        </center>
        <p>Welcome to the MIT App Inventor Companion Application. You use this application in conjunction with
            the MIT App Inventor application authoring system. You can learn more about it at http://appinventor.mit.edu.
        </p>
        <div id="needpermission" style="display:none;">
        <p>
            On modern Android devices you will be prompted to give permission for certain sensitive activities such as
            reading the location of your device. You will only receive these prompts when you attempt to perform
            these activities. Once you give permission, Android will remember and not ask you next time.
        </p>
        <p>
            The Companion needs CAMERA and STORAGE persmission. Press the "Get Permissions" button below to ask your device
            to grant these permissions. Each time you press the button you will be prompted for a missing permission. Once
            all permissions have been obtained, the "Get Permissions" button will disappear. Press "Continue" to use
            the Companion.
        </p>
        <p>&nbsp;</p>
        <button onclick="getpermission();">Get Permissions</button>
        </div>
        <p>&nbsp;</p>
        <div id="foo"></div>
        <button onclick="done();">Continue</button>
        <p>&nbsp;</p>
        <button id="sendbutton" disabled="true" onclick="sender();">Sender</button><br/><br/>
        <button id="receivebutton" disabled="true" onclick="receiver();">Receiver</button>
        <br/><br/>
        <div id="chat"></div>
        <br/><br/>
        <textarea id="send" rows="10" cols="70"></textarea>
        <br/><br/>
        <button id="chatbutton" onclick="chat();" disabled="true">Send Chat</button>
        <br/><br/>
        <input type="text" id="key" value=""/>
        <br/><br/>
        <button onclick="setkey();">Set Rendezvous Key</button>
    </body>
</html>
